name: Build & Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    env:
      CSC_IDENTITY_AUTO_DISCOVERY: 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build macOS app (unsigned)
        run: |
          npm run build -- \
            --mac \
            -c.mac.identity=null \
            -c.mac.hardenedRuntime=false \
            --publish never

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-artifacts
          path: |
            release/**/*.dmg
            release/**/*.zip
          if-no-files-found: error

  build-win:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Windows app (unsigned)
        run: npm run build -- --win --publish never

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win-artifacts
          path: release/**/*.exe
          if-no-files-found: error

  release:
    needs: [build-mac, build-win]
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: mac-artifacts
          path: artifacts

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: win-artifacts
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: false
          files: artifacts/**
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒï¼

            **æ³¨æ„ï¼šæœ¬é¡¹ç›®æš‚æ— å•†ä¸šç­¾åè¯ä¹¦ï¼Œå®‰è£…æ—¶å¯èƒ½ä¼šæç¤ºå®‰å…¨è­¦å‘Šã€‚**

            ### ğŸ macOS ç”¨æˆ·
            åˆæ¬¡å®‰è£…å¯èƒ½å‡ºç° â€œåº”ç”¨å·²æŸåï¼Œæ— æ³•æ‰“å¼€â€ æˆ– â€œæ¥è‡ªèº«ä»½ä¸æ˜çš„å¼€å‘è€…â€ã€‚

            è¯·æ‰“å¼€ã€Œç»ˆç«¯ã€æ‰§è¡Œï¼š

            ```bash
            xattr -cr /Applications/Voice\ Key.app
            ```

            ### ğŸªŸ Windows ç”¨æˆ·
            å¦‚æœå‡ºç° SmartScreen æç¤ºï¼š

            1. ç‚¹å‡» â€œæ›´å¤šä¿¡æ¯â€
            2. ç‚¹å‡» â€œä»è¦è¿è¡Œâ€

            ---

            ### æ›´æ–°æ—¥å¿—
            <!-- åœ¨è¿™é‡Œå¡«å†™æœ¬æ¬¡æ›´æ–°çš„å†…å®¹ -->
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
